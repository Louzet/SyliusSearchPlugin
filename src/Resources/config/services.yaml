parameters:
  monsieurbiz.search.model.documentable.interface: MonsieurBiz\SyliusSearchPlugin\Model\Documentable\DocumentableInterface
  monsieurbiz.search.request.interface: MonsieurBiz\SyliusSearchPlugin\Search\Request\RequestInterface

services:

  _defaults:
    autowire: true
    autoconfigure: true
    public: false
    bind:
      $localeProvider: '@sylius.translation_locale_provider'
      $productVariantResolver: '@sylius.product_variant_resolver.default'
      $documentableRegistry: '@monsieurbiz.search.registry.documentable'
      $searchRequestsRegistry: '@monsieurbiz.search.registry.search_request'
      $configurationDirectory: '@=service("file_locator").locate("@MonsieurBizSyliusSearchPlugin/Resources/config/elasticsearch")'

  MonsieurBiz\SyliusSearchPlugin\:
    resource: '../../*'
    exclude: '../../{Entity,Migrations,Tests,Kernel.php}'

  MonsieurBiz\SyliusSearchPlugin\Form\Extension\:
    resource: '../../Form/Extension'
    tags:
      - { name: form.type_extension }

  MonsieurBiz\SyliusSearchPlugin\Generated\:
    resource: '../../../generated'

  JoliCode\Elastically\IndexNameMapper:
    arguments:
      $prefix: null # or a string to prefix index name
      $indexClassMapping: {}

  JoliCode\Elastically\Serializer\StaticContextBuilder:
    arguments:
      $mapping: {}

  JoliCode\Elastically\ResultSetBuilder:
    arguments:
      $indexNameMapper: '@JoliCode\Elastically\IndexNameMapper'
      $contextBuilder: '@JoliCode\Elastically\Serializer\StaticContextBuilder'
      $denormalizer: '@serializer'

  # ES Client configuration
  monsieurbiz.search.elasticsearch.client:
    class: JoliCode\Elastically\Client
    arguments:
      $config:
        host: '%env(ELASTICSEARCH_HOST)%'
      $logger: '@logger'
      $resultSetBuilder: '@JoliCode\Elastically\ResultSetBuilder'
      $indexNameMapper: '@JoliCode\Elastically\IndexNameMapper'

  JoliCode\Elastically\Mapping\YamlProvider: ~

  MonsieurBiz\SyliusSearchPlugin\Repository\ProductAttributeRepository:
    arguments:
      $attributeRepository: '@sylius.repository.product_attribute'

  # Define our mapping provider
  MonsieurBiz\SyliusSearchPlugin\Mapping\YamlWithLocaleProvider:
    decorates: JoliCode\Elastically\Mapping\YamlProvider
    arguments:
      $decorated: '@.inner'

  # Replace the mapping provider by our mapping provider
  JoliCode\Elastically\IndexBuilder:
    arguments:
      $client: '@monsieurbiz.search.elasticsearch.client'
      $mappingProvider: '@MonsieurBiz\SyliusSearchPlugin\Mapping\YamlWithLocaleProvider'

  monsieurbiz.search.registry.documentable:
    class: Sylius\Component\Registry\ServiceRegistry
    arguments:
      $className: '%monsieurbiz.search.model.documentable.interface%'
      $context: 'documentable'

  monsieurbiz.search.registry.search_request:
    class: Sylius\Component\Registry\ServiceRegistry
    arguments:
      $className: '%monsieurbiz.search.request.interface%'
      $context: 'documentable'

  # Define product attribute value readers
  MonsieurBiz\SyliusSearchPlugin\AutoMapper\ProductAttributeValueConfiguration:
    arguments:
      $productAttributeValueReaders: {
        default: '@MonsieurBiz\SyliusSearchPlugin\AutoMapper\ProductAttributeValueReader\DefaultReader',
        select: '@MonsieurBiz\SyliusSearchPlugin\AutoMapper\ProductAttributeValueReader\SelectReader',
        date: '@MonsieurBiz\SyliusSearchPlugin\AutoMapper\ProductAttributeValueReader\DateReader'
      }

  # Define aggregation builders
  MonsieurBiz\SyliusSearchPlugin\Search\Request\Aggregation\MainTaxonAggregation:
    tags: { name: 'monsieurbiz.sarch.aggregation_builder' }

  MonsieurBiz\SyliusSearchPlugin\Search\Request\Aggregation\PriceAggregation:
    tags: { name: 'monsieurbiz.sarch.aggregation_builder' }

  MonsieurBiz\SyliusSearchPlugin\Search\Request\Aggregation\ProductAttributesAggregation:
    tags: { name: 'monsieurbiz.sarch.aggregation_builder' }

  MonsieurBiz\SyliusSearchPlugin\Search\Request\Aggregation\ProductOptionsAggregation:
    tags: { name: 'monsieurbiz.sarch.aggregation_builder' }

  MonsieurBiz\SyliusSearchPlugin\Search\Request\AggregationBuilder:
    arguments: [ !tagged_iterator { tag: 'monsieurbiz.sarch.aggregation_builder' } ]
